<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cena Split</title>
  <style>
    :root{
      --bg: #f4f6fb;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --border: rgba(15,23,42,.12);
      --primary: #2563eb;
      --primaryText: #ffffff;
      --shadow: 0 10px 30px rgba(2,6,23,.08);
      --radius: 16px;
      --radius2: 22px;
      --focus: 0 0 0 4px rgba(37,99,235,.18);
    }
    [data-theme="dark"]{
      --bg: #0b1220;
      --card: #0f1b31;
      --text: #e5e7eb;
      --muted: #a8b3cf;
      --border: rgba(226,232,240,.14);
      --primary: #3b82f6;
      --primaryText: #0b1220;
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --focus: 0 0 0 4px rgba(59,130,246,.22);
    }
    html,body{height:100%;}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 10% -10%, rgba(37,99,235,.12), transparent 55%),
                  radial-gradient(900px 500px at 95% 10%, rgba(99,102,241,.10), transparent 50%),
                  var(--bg);
      color: var(--text);
    }
    .wrap{max-width: 980px; margin: 0 auto; padding: 16px 14px 60px;}
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding: 10px 4px 14px;
      position: sticky; top:0; z-index: 5;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, color-mix(in srgb, var(--bg) 92%, transparent), transparent);
    }
    .title{
      display:flex; align-items:baseline; gap:10px; flex-wrap:wrap;
    }
    .title h1{font-size: 20px; margin:0; letter-spacing:.2px;}
    .pill{
      font-size:12px; color: var(--muted);
      padding: 6px 10px; border: 1px solid var(--border);
      border-radius: 999px; background: color-mix(in srgb, var(--card) 75%, transparent);
      white-space: nowrap;
    }
    .themeCtl{display:flex; gap:8px; align-items:center;}
    .btn{
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      cursor:pointer;
      box-shadow: 0 1px 0 rgba(2,6,23,.05);
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
      transition: transform .05s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .btn:hover{box-shadow: 0 10px 20px rgba(2,6,23,.08);}
    .btn:active{transform: translateY(1px);}
    .btn:focus{outline:none; box-shadow: var(--focus);}
    .btn.primary{
      border-color: color-mix(in srgb, var(--primary) 55%, var(--border));
      background: var(--primary); color: var(--primaryText);
    }
    .btn.danger{
      border-color: color-mix(in srgb, #ef4444 55%, var(--border));
      background: color-mix(in srgb, #ef4444 12%, var(--card));
      color: color-mix(in srgb, #ef4444 80%, var(--text));
    }
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns:1fr;}
      .topbar{position: static; backdrop-filter:none; background: transparent;}
    }
    .card{
      background: color-mix(in srgb, var(--card) 92%, transparent);
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .card h2{margin:0 0 6px; font-size:18px;}
    .sub{color: var(--muted); font-size: 13px; margin:0 0 12px;}
    .row{display:flex; gap: 12px; flex-wrap:wrap; align-items:flex-end;}
    .field{flex:1; min-width: 160px;}
    .field label{display:block; font-size: 12px; color: var(--muted); margin-bottom:6px;}
    input[type="text"], input[type="number"], select{
      width:100%;
      box-sizing:border-box;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--card) 92%, transparent);
      color: var(--text);
      font-size: 14px;
    }
    input[type="number"]{appearance: textfield;}
    input:focus, select:focus{outline:none; box-shadow: var(--focus); border-color: color-mix(in srgb, var(--primary) 55%, var(--border));}
    .table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0 10px;
      margin-top: 10px;
    }
    .thead{
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .08em;
    }
    .trow{
      background: color-mix(in srgb, var(--card) 94%, transparent);
      border: 1px solid var(--border);
      border-radius: 14px;
    }
    .trow td{
      padding: 10px;
      vertical-align: middle;
    }
    .trow td:first-child{padding-left: 12px; width:70px;}
    .trow td:last-child{padding-right: 12px;}
    .toggle{
      width: 40px; height: 24px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--card) 88%, transparent);
      display:flex; align-items:center; padding: 2px;
      cursor:pointer;
      user-select:none;
    }
    .knob{
      width: 20px; height: 20px;
      border-radius: 999px;
      background: color-mix(in srgb, var(--primary) 70%, var(--card));
      transform: translateX(0);
      transition: transform .2s ease;
    }
    .toggle.on .knob{transform: translateX(16px);}
    .iconBtn{
      width: 44px; height: 40px;
      border-radius: 12px;
      display:flex; align-items:center; justify-content:center;
      border: 1px solid var(--border);
      background: var(--card);
      cursor:pointer;
    }
    .iconBtn:focus{outline:none; box-shadow: var(--focus);}
    .muted{color: var(--muted);}
    .small{font-size:12px;}
    .kpiGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 520px){
      .kpiGrid{grid-template-columns:1fr;}
    }
    .kpi{
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      background: color-mix(in srgb, var(--card) 94%, transparent);
    }
    .kpi .label{font-size:12px; color: var(--muted);}
    .kpi .value{font-size: 18px; font-weight: 700; margin-top: 4px;}
    .divider{height:1px; background: var(--border); margin: 12px 0;}
    .actions{
      display:flex; gap: 10px; flex-wrap:wrap;
    }
    .actions .btn{flex: 1; justify-content:center; min-width: 160px; padding: 14px 14px; border-radius: 16px; font-size: 16px;}
    @media (max-width: 520px){
      .actions .btn{min-width: 100%;}
    }
    .notice{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px dashed color-mix(in srgb, var(--border) 75%, var(--muted));
      color: var(--muted);
      background: color-mix(in srgb, var(--card) 90%, transparent);
      font-size: 13px;
    }
    .familyCards{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 12px;
    }
    @media (max-width: 520px){
      .familyCards{grid-template-columns:1fr;}
    }
    .famCard{
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      background: color-mix(in srgb, var(--card) 94%, transparent);
      padding: 12px;
      overflow:hidden;
    }
    .famCard .name{font-weight: 900; font-size: 16px;}
    .famCard .meta{color: var(--muted); font-size: 12px; margin-top:4px;}
    .famCard .amount{font-weight: 1000; font-size: 40px; margin-top: 8px; letter-spacing: .3px;}
    .rightHeader{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .savedList{
      display:flex; flex-direction:column; gap:10px; margin-top:10px;
    }
    .savedItem{
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      background: color-mix(in srgb, var(--card) 94%, transparent);
      padding: 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .savedItem .main{display:flex; flex-direction:column; gap:4px;}
    .savedItem .main .t{font-weight:800;}
    .savedItem .main .d{font-size:12px; color: var(--muted);}
    .savedItem .tools{display:flex; gap:8px; align-items:center;}
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      background: color-mix(in srgb, var(--card) 92%, transparent);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 13px;
      color: var(--text);
      opacity: 0;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
    }
    .toast.show{opacity: 1; transform: translateX(-50%) translateY(-6px);}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="topbar">
      <div class="title">
        <h1>Cena Split</h1>
        <div class="pill" id="weightsPill">Adulti = 1 ¬∑ Bimbi = 0,5</div>
      </div>
      <div class="themeCtl">
        <button class="btn" id="themeBtn" title="Tema (Auto / Chiaro / Scuro)">
          <span id="themeIcon">üåì</span>
          <span id="themeLabel">Auto</span>
        </button>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <h2>Famiglie della cena</h2>
        <p class="sub">Aggiungi righe e calcola automaticamente quanto paga ogni famiglia.</p>

        <div class="row">
          <div class="field" style="flex:1.2">
            <label for="total">Totale conto (‚Ç¨)</label>
            <input id="total" type="number" inputmode="decimal" placeholder="es. 180" min="0" step="0.01" />
          </div>
          <div class="field" style="flex:.9">
            <label for="rounding">Arrotondamento</label>
            <select id="rounding">
              <option value="none">Nessuno</option>
              <option value="0.01">Al centesimo (0,01)</option>
              <option value="0.05">A 5 cent (0,05)</option>
              <option value="0.10">A 10 cent (0,10)</option>
              <option value="0.50">A 50 cent (0,50)</option>
              <option value="1">All'euro (1)</option>
            </select>
          </div>
        </div>

        <table class="table" aria-label="Famiglie della cena">
          <thead class="thead">
            <tr>
              <th style="text-align:left; padding-left:12px;">Usa</th>
              <th style="text-align:left;">Famiglia</th>
              <th style="text-align:left;">Adulti</th>
              <th style="text-align:left;">Bimbi</th>
              <th style="text-align:left;">&nbsp;</th>
            </tr>
          </thead>
          <tbody id="dinnerRows"></tbody>
        </table>

        <div class="row" style="justify-content:space-between; align-items:center; margin-top: 6px;">
          <button class="btn" id="addRowBtn">+ Aggiungi famiglia</button>
          <div class="actions" style="justify-content:flex-end; flex:1;">
            <button class="btn" id="saveSelectedBtn" title="Salva le famiglie selezionate come 'fisse'">
              üíæ Salva selezionate
            </button>
          </div>
        </div>

        <div class="divider"></div>
        <div class="notice">
          Suggerimento: salva le famiglie ‚Äúfisse‚Äù e poi spunta (Usa) solo quelle presenti a questa cena.
        </div>
      </section>

      <aside style="display:flex; flex-direction:column; gap:14px;">
        <section class="card">
          <div class="rightHeader">
            <div>
              <h2 style="margin:0;">Famiglie salvate</h2>
              <p class="sub" style="margin:6px 0 0;">Rimangono memorizzate sul tuo dispositivo (localStorage).</p>
            </div>
            <button class="btn danger" id="clearSavedBtn" title="Elimina tutte le famiglie salvate">Svuota</button>
          </div>

          <div class="savedList" id="savedList"></div>
          <div id="savedEmpty" class="muted">Nessuna famiglia salvata.</div>
        </section>

        <section class="card">
          <h2>Riepilogo</h2>
          <p class="sub">Quote per famiglia (selezionate) + riepilogo calcolo.</p>

          <div class="kpiGrid">
            <div class="kpi">
              <div class="label">Totale unit√† (adulti + bimbi√ó0,5)</div>
              <div class="value" id="kpiUnits">‚Äî</div>
            </div>
            <div class="kpi">
              <div class="label">Quota per unit√† (‚Ç¨)</div>
              <div class="value" id="kpiPerUnit">‚Äî</div>
            </div>
            <div class="kpi">
              <div class="label">Somma quote (‚Ç¨)</div>
              <div class="value" id="kpiSum">‚Äî</div>
            </div>
            <div class="kpi">
              <div class="label">Differenza vs totale (‚Ç¨)</div>
              <div class="value" id="kpiDiff">‚Äî</div>
            </div>
          </div>

          <div class="familyCards" id="familyCards" aria-label="Quote per famiglia"></div>

          <div class="divider"></div>

          <div class="actions">
            <button class="btn primary" id="shareBtn">Condividi su WhatsApp</button>
            <button class="btn" id="copyBtn">Copia testo</button>
          </div>

          <p class="muted small" id="hint">Inserisci il totale del conto.</p>
        </section>

        <section class="card">
          <h2>Note</h2>
          <div class="muted" style="line-height:1.5;">
            <div>‚Äì ‚ÄúUsa‚Äù = spunta chi partecipa a questa cena.</div>
            <div>‚Äì Dark mode: <b>Auto</b> segue il tema del telefono/OS, oppure puoi forzarla dal pulsante.</div>
            <div>‚Äì Nessuna PWA: niente installazione, solo web.</div>
          </div>
        </section>
      </aside>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
(() => {
  const ADULT_WEIGHT = 1;
  const KID_WEIGHT = 0.5;

  const $ = (sel) => document.querySelector(sel);
  const dinnerRowsEl = $("#dinnerRows");
  const totalEl = $("#total");
  const roundingEl = $("#rounding");
  const addRowBtn = $("#addRowBtn");
  const saveSelectedBtn = $("#saveSelectedBtn");
  const savedListEl = $("#savedList");
  const savedEmptyEl = $("#savedEmpty");
  const clearSavedBtn = $("#clearSavedBtn");
  const familyCardsEl = $("#familyCards");

  const kpiUnits = $("#kpiUnits");
  const kpiPerUnit = $("#kpiPerUnit");
  const kpiSum = $("#kpiSum");
  const kpiDiff = $("#kpiDiff");
  const shareBtn = $("#shareBtn");
  const copyBtn = $("#copyBtn");
  const hintEl = $("#hint");
  const toastEl = $("#toast");

  const themeBtn = $("#themeBtn");
  const themeLabel = $("#themeLabel");
  const themeIcon = $("#themeIcon");

  $("#weightsPill").textContent = `Adulti = ${ADULT_WEIGHT} ¬∑ Bimbi = ${String(KID_WEIGHT).replace('.', ',')}`;

  // ---------- Theme (Auto / Light / Dark) ----------
  function getSystemPrefersDark() {
    return window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
  }
  function getThemePref() {
    return localStorage.getItem("cenaSplit.theme") || "auto";
  }
  function applyTheme(pref) {
    const root = document.documentElement;
    const effective = pref === "auto" ? (getSystemPrefersDark() ? "dark" : "light") : pref;
    root.setAttribute("data-theme", effective === "dark" ? "dark" : "light");

    themeLabel.textContent = pref === "auto" ? "Auto" : (pref === "dark" ? "Scuro" : "Chiaro");
    themeIcon.textContent = pref === "auto" ? "üåì" : (pref === "dark" ? "üåô" : "‚òÄÔ∏è");
  }
  function cycleTheme() {
    const cur = getThemePref();
    const next = cur === "auto" ? "light" : (cur === "light" ? "dark" : "auto");
    localStorage.setItem("cenaSplit.theme", next);
    applyTheme(next);
    toast(`Tema: ${next === "auto" ? "Auto" : (next === "dark" ? "Scuro" : "Chiaro")}`);
  }
  themeBtn.addEventListener("click", cycleTheme);
  if (window.matchMedia) {
    window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", () => {
      if (getThemePref() === "auto") applyTheme("auto");
    });
  }
  applyTheme(getThemePref());

  // ---------- State ----------
  const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);

  let dinnerFamilies = [
    { id: uid(), name: "Famiglia 1", adults: 2, kids: 0, use: true },
  ];

  function loadSaved() {
    try {
      const raw = localStorage.getItem("cenaSplit.savedFamilies");
      const data = raw ? JSON.parse(raw) : [];
      return Array.isArray(data) ? data : [];
    } catch {
      return [];
    }
  }
  function storeSaved(list) {
    localStorage.setItem("cenaSplit.savedFamilies", JSON.stringify(list));
  }

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(()=>toastEl.classList.remove("show"), 1600);
  }

  // ---------- Helpers ----------
  const euro = (n) => {
    if (!isFinite(n)) return "‚Äî";
    return n.toLocaleString("it-IT", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  };

  function roundToStep(value, step){
    if (!step || step === "none") return value;
    const s = parseFloat(step);
    if (!isFinite(s) || s <= 0) return value;
    return Math.round(value / s) * s;
  }

  function calcUnits(adults, kids){
    const a = Math.max(0, Number(adults) || 0);
    const k = Math.max(0, Number(kids) || 0);
    return a * ADULT_WEIGHT + k * KID_WEIGHT;
  }

  function renderDinnerRows(){
    dinnerRowsEl.innerHTML = "";
    dinnerFamilies.forEach((f) => {
      const tr = document.createElement("tr");
      tr.className = "trow";

      const tdUse = document.createElement("td");
      const toggle = document.createElement("div");
      toggle.className = "toggle" + (f.use ? " on" : "");
      toggle.setAttribute("role", "switch");
      toggle.setAttribute("aria-checked", String(!!f.use));
      toggle.title = "Partecipa a questa cena";
      const knob = document.createElement("div");
      knob.className = "knob";
      toggle.appendChild(knob);
      toggle.addEventListener("click", () => {
        f.use = !f.use;
        renderDinnerRows();
        recompute();
      });
      tdUse.appendChild(toggle);

      const tdName = document.createElement("td");
      const inpName = document.createElement("input");
      inpName.type = "text";
      inpName.value = f.name || "";
      inpName.placeholder = "Nome famiglia";
      inpName.addEventListener("input", (e) => {
        f.name = e.target.value;
        recompute(false);
      });
      tdName.appendChild(inpName);

      const tdA = document.createElement("td");
      const inpA = document.createElement("input");
      inpA.type = "number";
      inpA.min = "0";
      inpA.step = "1";
      inpA.inputMode = "numeric";
      inpA.value = String(f.adults ?? 0);
      inpA.addEventListener("input", (e) => {
        f.adults = Math.max(0, parseInt(e.target.value || "0", 10) || 0);
        recompute();
      });
      tdA.appendChild(inpA);

      const tdK = document.createElement("td");
      const inpK = document.createElement("input");
      inpK.type = "number";
      inpK.min = "0";
      inpK.step = "1";
      inpK.inputMode = "numeric";
      inpK.value = String(f.kids ?? 0);
      inpK.addEventListener("input", (e) => {
        f.kids = Math.max(0, parseInt(e.target.value || "0", 10) || 0);
        recompute();
      });
      tdK.appendChild(inpK);

      const tdDel = document.createElement("td");
      const del = document.createElement("button");
      del.className = "iconBtn";
      del.title = "Rimuovi";
      del.textContent = "üóëÔ∏è";
      del.addEventListener("click", () => {
        dinnerFamilies = dinnerFamilies.filter(x => x.id !== f.id);
        if (dinnerFamilies.length === 0) {
          dinnerFamilies = [{ id: uid(), name:"Famiglia 1", adults:2, kids:0, use:true }];
        }
        renderDinnerRows();
        recompute();
      });
      tdDel.appendChild(del);

      tr.appendChild(tdUse);
      tr.appendChild(tdName);
      tr.appendChild(tdA);
      tr.appendChild(tdK);
      tr.appendChild(tdDel);

      dinnerRowsEl.appendChild(tr);
    });
  }

  function renderSaved(){
    const saved = loadSaved();
    savedListEl.innerHTML = "";
    savedEmptyEl.style.display = saved.length ? "none" : "block";

    saved.forEach((sf) => {
      const item = document.createElement("div");
      item.className = "savedItem";

      const main = document.createElement("div");
      main.className = "main";
      const t = document.createElement("div");
      t.className = "t";
      t.textContent = sf.name || "Famiglia";
      const d = document.createElement("div");
      d.className = "d";
      d.textContent = `${sf.adults || 0} adulti ¬∑ ${sf.kids || 0} bimbi`;
      main.appendChild(t); main.appendChild(d);

      const tools = document.createElement("div");
      tools.className = "tools";

      const addBtn = document.createElement("button");
      addBtn.className = "btn";
      addBtn.style.padding = "10px 12px";
      addBtn.textContent = "‚ûï Aggiungi";
      addBtn.title = "Aggiungi questa famiglia alla cena (spuntata)";
      addBtn.addEventListener("click", () => {
        dinnerFamilies.push({ id: uid(), name: sf.name, adults: sf.adults || 0, kids: sf.kids || 0, use: true });
        renderDinnerRows();
        recompute();
        toast("Aggiunta alla cena");
      });

      const delBtn = document.createElement("button");
      delBtn.className = "iconBtn";
      delBtn.textContent = "üóëÔ∏è";
      delBtn.title = "Elimina dalla lista salvata";
      delBtn.addEventListener("click", () => {
        const next = loadSaved().filter(x => x.id !== sf.id);
        storeSaved(next);
        renderSaved();
        toast("Eliminata");
      });

      tools.appendChild(addBtn);
      tools.appendChild(delBtn);

      item.appendChild(main);
      item.appendChild(tools);
      savedListEl.appendChild(item);
    });
  }

  function recompute(updateCards=true){
    const total = parseFloat(String(totalEl.value).replace(",", ".")) || 0;
    const step = roundingEl.value;

    const selected = dinnerFamilies.filter(f => !!f.use);
    const unitByFamily = selected.map(f => ({
      id: f.id,
      name: (f.name || "Famiglia").trim() || "Famiglia",
      units: calcUnits(f.adults, f.kids)
    }));

    const totalUnits = unitByFamily.reduce((s,x)=>s + x.units, 0);

    let perUnit = 0;
    if (total > 0 && totalUnits > 0) perUnit = total / totalUnits;

    const computed = unitByFamily.map(x => {
      const raw = x.units * perUnit;
      const rounded = (step === "none") ? raw : roundToStep(raw, step);
      return { ...x, raw, rounded };
    });

    let sum = computed.reduce((s,x)=>s + x.rounded, 0);
    if (total > 0 && computed.length && step !== "none") {
      const diff = total - sum;
      computed[computed.length-1].rounded += diff;
      sum = computed.reduce((s,x)=>s + x.rounded, 0);
    }

    const diffVsTotal = total - sum;

    kpiUnits.textContent = totalUnits ? totalUnits.toLocaleString("it-IT", { maximumFractionDigits: 2 }) : "‚Äî";
    kpiPerUnit.textContent = (total > 0 && totalUnits > 0) ? euro(perUnit) : "‚Äî";
    kpiSum.textContent = (total > 0 && totalUnits > 0) ? euro(sum) : "‚Äî";
    kpiDiff.textContent = (total > 0 && totalUnits > 0) ? euro(diffVsTotal) : "‚Äî";

    if (updateCards){
      familyCardsEl.innerHTML = "";
      computed.forEach(x => {
        const card = document.createElement("div");
        card.className = "famCard";

        const name = document.createElement("div");
        name.className = "name";
        name.textContent = x.name;

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = `${x.units.toLocaleString("it-IT", { maximumFractionDigits: 2 })} unit√†`;

        const amount = document.createElement("div");
        amount.className = "amount";
        const val = (step === "none") ? x.raw : x.rounded;
        amount.textContent = `${euro(val)} ‚Ç¨`;

        card.appendChild(name);
        card.appendChild(meta);
        card.appendChild(amount);
        familyCardsEl.appendChild(card);
      });
    }

    if (!total) hintEl.textContent = "Inserisci il totale del conto.";
    else if (!selected.length) hintEl.textContent = "Spunta almeno una famiglia (Usa).";
    else hintEl.textContent = "Pronto: condividi o copia il testo.";

    const lines = [];
    lines.push(`Cena Split`);
    if (total) lines.push(`Totale: ${euro(total)} ‚Ç¨`);
    if (totalUnits) lines.push(`Quota per unit√†: ${euro(perUnit)} ‚Ç¨`);
    lines.push("");
    lines.push("Quote:");
    computed.forEach(x => {
      const val = (step === "none") ? x.raw : x.rounded;
      lines.push(`‚Ä¢ ${x.name}: ${euro(val)} ‚Ç¨ (${x.units.toLocaleString("it-IT",{maximumFractionDigits:2})} unit√†)`);
    });
    const text = lines.join("\\n");

    shareBtn.disabled = !(total > 0 && selected.length);
    copyBtn.disabled = !(total > 0 && selected.length);
    shareBtn.dataset.text = text;
    copyBtn.dataset.text = text;
  }

  // ---------- Events ----------
  addRowBtn.addEventListener("click", () => {
    dinnerFamilies.push({ id: uid(), name: `Famiglia ${dinnerFamilies.length + 1}`, adults: 2, kids: 0, use: true });
    renderDinnerRows();
    recompute();
  });

  saveSelectedBtn.addEventListener("click", () => {
    const selected = dinnerFamilies.filter(f => !!f.use);
    if (!selected.length) return toast("Seleziona almeno una famiglia");
    const saved = loadSaved();
    selected.forEach(f => {
      const name = (f.name || "Famiglia").trim() || "Famiglia";
      const existing = saved.find(x => (x.name || "").trim().toLowerCase() === name.toLowerCase());
      if (existing) {
        existing.adults = f.adults || 0;
        existing.kids = f.kids || 0;
      } else {
        saved.push({ id: uid(), name, adults: f.adults || 0, kids: f.kids || 0 });
      }
    });
    storeSaved(saved);
    renderSaved();
    toast("Salvate");
  });

  clearSavedBtn.addEventListener("click", () => {
    storeSaved([]);
    renderSaved();
    toast("Lista salvata svuotata");
  });

  totalEl.addEventListener("input", () => recompute());
  roundingEl.addEventListener("change", () => recompute());

  shareBtn.addEventListener("click", async () => {
    const text = shareBtn.dataset.text || "";
    if (!text) return;
    if (navigator.share) {
      try {
        await navigator.share({ text });
        toast("Condiviso");
        return;
      } catch {}
    }
    const url = "https://wa.me/?text=" + encodeURIComponent(text);
    window.open(url, "_blank", "noopener,noreferrer");
  });

  copyBtn.addEventListener("click", async () => {
    const text = copyBtn.dataset.text || "";
    if (!text) return;
    try {
      await navigator.clipboard.writeText(text);
      toast("Copiato negli appunti");
    } catch {
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      toast("Copiato");
    }
  });

  // ---------- Init ----------
  renderDinnerRows();
  renderSaved();
  recompute();

})();
</script>
</body>
</html>
